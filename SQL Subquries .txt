--We want to find the average number of events for each day for each channel.

SELECT channel, AVG(count)
FROM
    (SELECT DATE_TRUNC('day',occurred_at), channel,      COUNT(*) count
     FROM web_events
     GROUP BY 1,2) sub
GROUP BY channel;

--The average amount for each type of paper sold on the first month that any order was placed in the orders table (in terms of quantity)

SELECT AVG(standard_qty) standard, AVG(gloss_qty) gloss, AVG(poster_qty) poster
FROM orders
WHERE DATE_TRUNC('month', occurred_at) =
     (SELECT DATE_TRUNC('month', Min(occurred_at))
      FROM orders);

--Provide the name of the sales_rep in each region with the largest amount of total_amt_usd sales.

SELECT *
FROM
 (SELECT region, MAX(total) maxtotal
  FROM
    (SELECT s.name salerep, r.name region, SUM(total_amt_usd) total
     FROM region r
     JOIN sales_reps s
       ON r.id = s.region_id
     JOIN accounts a
       ON s.id = a.sales_rep_id
     JOIN orders o
       ON o.account_id = a.id
     GROUP BY 2,1) s1
   GROUP BY  1) s2
JOIN 
   (SELECT s.name salerep, r.name region, SUM(total_amt_usd) total
     FROM region r
     JOIN sales_reps s
       ON r.id = s.region_id
     JOIN accounts a
       ON s.id = a.sales_rep_id
     JOIN orders o
       ON o.account_id = a.id
     GROUP BY 2,1) s3
ON s3.total = s2.maxtotal

--How many accounts had more total purchases than the account name which has bought the most standard_qty paper throughout their lifetime as a customer?

SELECT a.name, SUM(o.total) totalpurchase
FROM accounts a
JOIN orders o
    ON o.account_id = a.id
GROUP BY 1
HAVING SUM(o.total) >
  (SELECT total
  FROM
      (SELECT a.name acc, SUM(standard_qty) totalsale, SUM(total) total
       FROM accounts a
       JOIN orders o
         ON o.account_id = a.id
       GROUP BY 1
       ORDER BY 2 DESC
       LIMIT 1) t1)

--For the customer that spent the most (in total over their lifetime as a customer) total_amt_usd, how many web_events did they have for each channel?

--cach1

SELECT a.name accname, w.channel, COUNT(*) num_event
FROM accounts a
JOIN web_events w
    ON w.account_id = a.id
GROUP BY 1,2
HAVING a.name =
      (SELECT name
       FROM
           (SELECT a.name, SUM(total_amt_usd) totalspend
            FROM accounts a
            JOIN orders o
                ON o.account_id = a.id
            JOIN web_events w
                ON w.account_id = a.id
            GROUP BY 1
            ORDER BY 2 DESC
            LIMIT 1) t1);

--cach2

WITH
     t2 AS (SELECT AVG(total_amt_usd)
           FROM orders),
     t1 AS (SELECT account_id, AVG(total_amt_usd) totalspent
           FROM orders
           GROUP BY 1
           HAVING AVG(total_amt_usd) > (SELECT * FROM t2))      
SELECT AVG(total_amt_usd)
FROM orders
WHERE account_id IN (SELECT account_id FROM t1);